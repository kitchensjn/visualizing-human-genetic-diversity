<!DOCTYPE html>
<html lang="en">
    <head>
        <title>tskit_arg_visualizer</title>
        <meta charset="utf-8">
        <script defer src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
        <script src='https://d3js.org/d3.v7.min.js'></script>
    </head>
    <body>
        <script type="module">
            const pyodide = await loadPyodide();
            await pyodide.loadPackage(["shapely"]);
            const shapely = await pyodide.pyimport("shapely");
            
            pyodide.runPython(`
                import js
                import math
                from shapely.geometry import Polygon


                def createPointsListForEllipse(x, y, a, b, angle):
                    y = -y
                    angle = -angle
                    theta = [x * 2 * math.pi / 100 for x in range(100)]
                    coords = []
                    for i in theta:
                        coords.append([a * math.cos(i) * math.cos(angle) - b * math.sin(i) * math.sin(angle) + x, a * math.cos(i) * math.sin(angle) + b * math.sin(i) * math.cos(angle) + y]) 
                    return coords


                def calcIntersectPercentage(data):
                    u = Polygon(createPointsListForEllipse(data[0].h, data[0].k, data[0].a, data[0].b, data[0].phi))
                    i = Polygon(createPointsListForEllipse(data[0].h, data[0].k, data[0].a, data[0].b, data[0].phi))
                    for e in data[1:]:
                        ellipse = Polygon(createPointsListForEllipse(e.h, e.k, e.a, e.b, e.phi))
                        u = u.union(ellipse)
                        i = i.intersection(ellipse)
                    return i.area / u.area

                def calcUniquePercentage(data):
                    all = []
                    u = Polygon(createPointsListForEllipse(data[0].h, data[0].k, data[0].a, data[0].b, data[0].phi))
                    for i,p in enumerate(data):
                        poly_p = Polygon(createPointsListForEllipse(p.h, p.k, p.a, p.b, p.phi))
                        if i != 0:
                            u = u.union(poly_p)
                        for j,q in enumerate(data):
                            if i != j:
                                poly_q = Polygon(createPointsListForEllipse(q.h, q.k, q.a, q.b, q.phi))
                                poly_p = poly_p.difference(poly_q)
                        all.append(poly_p.area)
                    return sum(all) / u.area

                
                js.intersectionStats = calcIntersectPercentage
                js.uniqueStats = calcUniquePercentage
            `);


            var data = [
                    {"abbreviation":"PEL","h":2493.9592,"k":-3127.3259,"a":1139.4186,"b":1374.1214,"phi":1.0056,"common_variants":5140058,"unshared_common_variants":99338,"description":"Peruvian in Lima, Peru","sampled_individuals":85,"color":"#E69F00","fill":"none","stroke_dasharray":"none"},
                    {"abbreviation":"MXL","h":2493.9592,"k":3127.3259,"a":1298.0515,"b":1327.9438,"phi":-1.3532,"common_variants":5663208,"unshared_common_variants":43322,"description":"Mexican Ancestry in Los Angeles, California","sampled_individuals":64,"color":"#56B4E9","fill":"none","stroke_dasharray":"none"},
                    {"abbreviation":"CEU","h":-3603.8755,"k":1735.535,"a":1518.3666,"b":1150.6006,"phi":1.187,"common_variants":5726377,"unshared_common_variants":184313,"description":"Utah residents (CEPH) with Northern and Western European ancestry","sampled_individuals":99,"color":"#CC79A7","fill":"none","stroke_dasharray":"none"},
                    {"abbreviation":"CLM","h":-3603.8755,"k":-1735.535,"a":1247.0832,"b":1433.2207,"phi":-0.2126,"common_variants":5895649,"unshared_common_variants":37361,"description":"Colombian in Medellin, Colombia","sampled_individuals":94,"color":"#009E73","fill":"none","stroke_dasharray":"none"},
                    {"abbreviation":"PUR","h":-890.0837,"k":3899.7116,"a":1435.6344,"b":1296.4881,"phi":-1.5072,"common_variants":6053543,"unshared_common_variants":51810,"description":"Puerto Rican in Puerto Rico","sampled_individuals":104,"color":"#000000","fill":"none","stroke_dasharray":"none"},
                    {"abbreviation":"ASW","h":-890.0837,"k":-3899.7116,"a":1753.6272,"b":1346.1266,"phi":-1.7434,"common_variants":7631052,"unshared_common_variants":321566,"description":"African Ancestry in Southwest US","sampled_individuals":61,"color":"#0072B2","fill":"none","stroke_dasharray":"none"},
                    {"abbreviation":"ACB","h":4000,"k":0,"a":1661.9991,"b":1482.8142,"phi":-2.3891,"common_variants":8018649,"unshared_common_variants":840969,"description":"African Caribbean in Barbados","sampled_individuals":96,"color":"#D55E00","fill":"none","stroke_dasharray":"none"}
                ];
            var id = "americas_example_euler";
            var dim = 1000;
            var title = "Americas";
            var title_color = "#696969";
            var flip_title = "";
            var loc = "body";
            var interactive = true;

            var create_form = d3.select(loc).append("form").attr("name", "submit-to-google-sheet");
                
            create_form
                .selectAll("ellipses")
                .data(data)
                .enter()
                .append("input")
                    .attr("type", "hidden")
                    .attr("name", function(d) { return d.abbreviation + ".h"; })
                    .attr("value", function(d) { return d.h; });
            
            create_form
                .selectAll("ellipses")
                .data(data)
                .enter()
                .append("input")
                    .attr("type", "hidden")
                    .attr("name", function(d) { return d.abbreviation + ".k"; })
                    .attr("value", function(d) { return d.k; });
            
            create_form.append("button").attr("type", "submit").text("Submit Diagram");

            var percent_overlap = d3.select(loc).append("div").attr("id", "overlap").style("display", "flex");
            percent_overlap.append("span").attr("id", "overlap_value").text(Math.round(intersectionStats(data)*100)+"%");
            percent_overlap.append("p").style("margin", "0px 0px 0px 5px").text("of variants that are common in at least one sample are common in every sample.");

            var percent_unique = d3.select(loc).append("div").attr("id", "overlap").style("display", "flex");
            percent_unique.append("span").attr("id", "unique_value").text(Math.round(uniqueStats(data)*100)+"%");
            percent_unique.append("p").style("margin", "0px 0px 0px 5px").text("of variants are common in only one sample.");

            
            var svg_container = d3.select(loc)
                .append("svg")
                .attr("id", id)
                .attr("width", dim)
                .attr("viewBox", "0 0 " + dim + " " + dim);

            var downscale = 15;
            var shift = dim/2;

            svg_container
                .selectAll("ellipses")
                .data(data)
                .enter()
                .append("path")
                .attr("id", function(d) { return d._row; })
                .attr("stroke", function(d) { return d.color; })
                .attr("stroke-width", 3)
                .attr("stroke-dasharray", function(d) { return d.stroke_dasharray; })
                .attr("fill", function(d) { return d.fill; })
                .attr("d", function(d) {
                    return ["M", (d.h/downscale+d.a/downscale+shift), (d.k/downscale+shift), "A", d.a/downscale, d.b/downscale, 0, 1, 1, (d.h/downscale+d.a/downscale+shift), (d.k/downscale+shift-0.001)].join(' ')
                })
                .attr("transform", function(d) {
                    return "rotate(" + d.phi*(180/Math.PI) + " " + (d.h/downscale+shift) + " " + (d.k/downscale+shift) + ")"; 
                });

            if (interactive) {
                svg_container
                    .selectAll("path")
                        .on("mouseover", function(event, d) {
                            d3.select(this)
                                .style("cursor", "grab")
                                .style("stroke-width", 7)
                                .style("opacity", 1);
                        })
                        .on("mouseout", function(d) {
                            d3.select("#"+id)
                                .selectAll("path")
                                    .style("opacity", 1)
                                    .style("stroke-width", 3);
                        })
                        .call(d3.drag()
                            .on("start", dragstart)
                            .on("drag", dragging)
                            .on("end", dragend));
            }

            function dragstart(event, d) {
                d3.select("body").style("cursor", "grabbing");
                d3.select("#"+id)
                    .selectAll("path")
                        .style("pointer-events", "none")
                        .style("opacity", 0.25);
                d3.select(this)
                    .style("opacity", 1);
                d3.select("#overlap_value").text(Math.round(intersectionStats(data)*100)+"%");
                d3.select("#unique_value").text(Math.round(uniqueStats(data)*100)+"%");
            }

            function dragging(event, d) {
                d3.select("#"+id)
                    .selectAll("path")
                        .style("pointer-events", "none")
                        .style("opacity", 0.25);
                d3.select(this)
                    .style("stroke-width", 7)
                    .style("opacity", 1);
                d.h = d.h + event.dx*downscale;
                d.k = d.k + event.dy*downscale;
                d3.select(this)
                    .attr("d", function(d) {
                        return ["M", (d.h/downscale+d.a/downscale+shift), (d.k/downscale+shift), "A", d.a/downscale, d.b/downscale, 0, 1, 1, (d.h/downscale+d.a/downscale+shift), (d.k/downscale+shift-0.001)].join(' ')
                    })
                    .attr("transform", function(d) {
                        return "rotate(" + d.phi*(180/Math.PI) + " " + (d.h/downscale+shift) + " " + (d.k/downscale+shift) + ")";
                    });
                d3.select("#overlap_value").text(Math.round(intersectionStats(data)*100)+"%");
                d3.select("#unique_value").text(Math.round(uniqueStats(data)*100)+"%");
            }

            function dragend(event, d) {
                d3.select("body").style("cursor", "initial");
                d3.select("#"+id)
                    .selectAll("path")
                        .style("pointer-events", "initial")
                        .style("opacity", 1);
                
                d3.selectAll("input")
                    .filter(function() {
                        return d3.select(this).attr("name") == d.abbreviation + ".k";
                    })
                    .attr("value", function(d) { return d.k; });
                
                d3.selectAll("input")
                    .filter(function() {
                        return d3.select(this).attr("name") == d.abbreviation + ".h";
                    })
                    .attr("value", function(d) { return d.h; });
                
                d3.select("#overlap_value").text(Math.round(intersectionStats(data)*100)+"%");
                d3.select("#unique_value").text(Math.round(uniqueStats(data)*100)+"%");
            }
            
            if (title != "") {
                if (flip_title != "") {
                    svg_container
                        .append("text")
                        .text(title)
                        .attr("x", dim/2)
                        .attr("y", dim/2)
                        .attr("text-anchor", "middle")
                        .attr("transform", "rotate(180, " + dim/2 + ", " + dim/2 + ")")
                        .style("font-family", "Arial")
                        .style("font-size", 25)
                        .style("fill", title_color)
                        .call(wrap, 300, 0, 1);
                } else {
                    svg_container
                        .append("text")
                        .text(title)
                        .attr("x", dim/2)
                        .attr("y", dim/2)
                        .attr("text-anchor", "middle")
                        .style("font-family", "Arial")
                        .style("font-size", 25)
                        .style("fill", title_color)
                        .call(wrap, 300, 0, 1);
                }
            }

            const scriptURL = "https://script.google.com/macros/s/AKfycbyK5W2y9UQDdoBpOThyY77QSZzjb3ZJvo8CQ6pvRD0yzxsnAihPKMrjmweA_bkxe0YP/exec"
            const form = document.forms['submit-to-google-sheet']
        
            form.addEventListener('submit', e => {
                e.preventDefault()
                fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                    .then(response => {window.location.href = "https://james-kitchens.com/blog/visualizing-human-genetic-diversity"})
                    .catch(error => console.error('Error!', error.message))
            })
        </script>
    </body>
</html>